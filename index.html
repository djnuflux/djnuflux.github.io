<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BugBot Leaderboards</title>
  <style>
    /* ---- Reset / Base ---- */
    *,*::before,*::after{box-sizing:border-box}
    :root{
      --bg1:#0b1020;          /* deep space */
      --bg2:#141b34;          /* dusk */
      --card:#111827cc;       /* glass card */
      --card-border:#2a3557;  /* subtle border */
      --acc:#7dd3fc;          /* cyan */
      --acc2:#a78bfa;         /* purple */
      --text:#e5e7eb;         /* light */
      --muted:#9ca3af;        /* muted */
      --chip:#1f2937;         /* chip bg */
      --shine:linear-gradient(135deg,var(--acc),var(--acc2));
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font:15px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #1d2547 0%, transparent 60%),
                  radial-gradient(800px 800px at 100% 0%, #2a1f58 0%, transparent 50%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      background-attachment: fixed;
    }

    /* ---- Layout ---- */
    .max{max-width:1100px;margin:32px auto;padding:0 20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:#0b1020cc; border:1px solid var(--card-border);
      box-shadow:0 0 0 4px #ffffff10, var(--shadow);
      display:grid;place-items:center;overflow:hidden
    }
    .logo img{width:100%;height:100%;object-fit:contain;image-rendering:auto}
    .title{font-size:22px;font-weight:700;letter-spacing:.3px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #334155;border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center}
    .chip input, .chip select{
      background:transparent;border:none;outline:none;color:var(--text);font:inherit;min-width:140px
    }

    .grid{display:grid;gap:18px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

    .card{
      background:var(--card);backdrop-filter: blur(8px);
      border:1px solid var(--card-border);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden
    }
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid #263253;background:#0f172acc}

    /* ---- Table ---- */
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{padding:12px 14px;border-bottom:1px solid #1f2937}
    .tbl th{font-weight:600;white-space:nowrap;position:sticky;top:0;background:#0f172aee;backdrop-filter: blur(6px);}
    .tbl th button{all:unset;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .tbl th button .sort{opacity:.6;font-size:12px}
    .tbl tr:hover td{background:#0b1224}
    .muted{color:var(--muted)}

    /* ---- Species list card ---- */
    .species-wrap{display:flex;gap:10px;flex-wrap:wrap;padding:14px}
    .species{border:1px solid #334155;background:#0b1224;border-radius:12px;padding:8px 10px;display:flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--acc);box-shadow:0 0 10px var(--acc)}

    /* ---- Name styles (Twitch color / 7TV paint) ---- */
    .name{display:inline-flex;align-items:center;gap:8px}
    .name .swatch{width:10px;height:10px;border-radius:50%;background:#ffffff33;border:1px solid #ffffff22;box-shadow:0 0 0 2px #00000030}
    .name .paint{display:inline-block;-webkit-background-clip:text;background-clip:text;color:transparent}

    /* ---- Footer ---- */
    footer{opacity:.6;padding:18px 0;text-align:center}

    /* ---- Subtle focus ring ---- */
    :focus-visible{outline:2px solid #7dd3fc66;outline-offset:2px;border-radius:8px}
  </style>
  <link rel="icon" href="icon.png" sizes="any" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="shortcut icon" href="icon.png" type="image/png">
  <meta property="og:image" content="icon.png">
  <meta name="theme-color" content="#0b1020">
</head>
<body>
  <div class="max">
    <header>
      <div class="brand">
        <div class="logo"><img src="icon.png" alt="BugBot" width="40" height="40" decoding="async" loading="eager"></div>
        <div class="title">BugBot Leaderboards</div>
      </div>
      <div class="toolbar">
        <label class="chip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6"/></svg>
          <input id="search" placeholder="Search user…" />
        </label>
        <label class="chip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.6"/></svg>
          <select id="speciesFilter"><option value="">All species</option></select>
        </label>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Top Catches</h2>
        <table class="tbl" id="top-catches">
          <thead><tr>
            <th><button data-k="username">User <span class="sort">⇅</span></button></th>
            <th><button data-k="total_catches" data-n>Catch Count <span class="sort">⇅</span></button></th>
            <th><button data-k="level" data-n>Level <span class="sort">⇅</span></button></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card">
        <h2>Top Levels</h2>
        <table class="tbl" id="top-levels">
          <thead><tr>
            <th><button data-k="username">User <span class="sort">⇅</span></button></th>
            <th><button data-k="level" data-n>Level <span class="sort">⇅</span></button></th>
            <th><button data-k="xp" data-n>XP (0–1) <span class="sort">⇅</span></button></th>
            <th><button data-k="total_catches" data-n>Catches <span class="sort">⇅</span></button></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card" style="grid-column:1/-1">
        <h2>Biggest by Species</h2>
        <table class="tbl" id="biggest">
          <thead><tr>
            <th><button data-k="species">Species <span class="sort">⇅</span></button></th>
            <th><button data-k="size_mm" data-n>Size (mm) <span class="sort">⇅</span></button></th>
            <th><button data-k="username">User <span class="sort">⇅</span></button></th>
          </tr></thead>
          <tbody></tbody>
        </table>
        <div class="species-wrap" id="speciesChips"></div>
      </section>
    </div>

    <footer>
      <span id="stamp" class="muted"></span>
    </footer>
  </div>

  <script>
    // Resolve the data file relative to this page, regardless of subpath
    // Robust data locator: try common locations in order
const CANDIDATES = [
  new URL('data/leaderboard.json', document.baseURI).toString(),
  new URL('/data/leaderboard.json', document.baseURI).toString(),
  new URL('/docs/data/leaderboard.json', document.baseURI).toString()
];

async function loadData(){
  for (const url of CANDIDATES){
    try {
      console.log('[leaderboard] trying', url);
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) { continue; }
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) { continue; }
      return await res.json();
    } catch (_) {}
  }
  throw new Error('Could not find leaderboard.json (tried: '+CANDIDATES.join(', ')+')');
}

const $ = s => document.querySelector(s);

function showError(msg){(msg){
      const el = document.getElementById('stamp');
      if(el) el.textContent = msg;
      console.error('[leaderboard]', msg);
    }

    function safeHex(hex){
      if(!hex || typeof hex !== 'string') return null;
      const m = hex.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
      return m ? m[0] : null;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function paintObjectToCSS(p){
      // Supports simple 7TV-style objects: {type:'linear'|'radial'|'conic', angle:90, stops:[['#a',0],['#b',1]]}
      try{
        if (!p || typeof p !== 'object' || !Array.isArray(p.stops)) return null;
        const type = (p.type||'linear').toLowerCase();
        const angle = (p.angle!=null ? p.angle : 90);
        const stops = p.stops.map(s=> (Array.isArray(s) ? `${s[0]} ${Math.round((s[1]||0)*100)}%` : String(s))).join(',');
        if (type === 'radial') return `radial-gradient(circle, ${stops})`;
        if (type === 'conic')  return `conic-gradient(from ${angle}deg, ${stops})`;
        return `linear-gradient(${angle}deg, ${stops})`;
      }catch{ return null; }
    }

    function renderName(row){
      const name = escapeHtml(row.username ?? '');
      const color = safeHex(row.name_color);
      let paint = row.paint_css; // can be a string 'linear-gradient(...)' or an object
      let css = null;
      if (paint) {
        if (typeof paint === 'string') css = paint.trim();
        else css = paintObjectToCSS(paint);
      }
      if (css){
        return `<span class="name"><span class="swatch" style="background:${css}"></span><span class="paint" style="background:${css}">${name}</span></span>`;
      }
      if (color){
        return `<span class="name"><span class="swatch" style="background:${color}"></span><span style="color:${color}">${name}</span></span>`;
      }
      return `<span class="name"><span class="swatch"></span><span>${name}</span></span>`;
    }"></span><span class="paint" style="background:${paint}">${name}</span></span>`;
      }
      if (color){
        return `<span class="name"><span class="swatch" style="background:${color}"></span><span style="color:${color}">${name}</span></span>`;
      }
      return `<span class="name"><span class="swatch"></span><span>${name}</span></span>`;
    }

    function renderTable(id, rows, columns) {
      const tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        columns.forEach(k => {
          const td = document.createElement('td');
          if (k === 'username') {
            td.innerHTML = renderName(r);
          } else {
            let v = r[k];
            if (typeof v === 'number') {
              if (k === 'xp') v = v.toFixed(3);
              if (k === 'size_mm') v = Number(v).toFixed(1);
            }
            td.textContent = (v ?? '');
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function attachSort(tableId, rows, columns) {
      const ths = document.querySelectorAll(`#${tableId} thead th button`);
      ths.forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.k;
          const numeric = btn.hasAttribute('data-n');
          const dir = btn.dataset.dir === 'asc' ? 'desc' : 'asc';
          ths.forEach(b => b.removeAttribute('data-dir'));
          btn.setAttribute('data-dir', dir);
          rows.sort((a,b) => {
            const A = a[key];
            const B = b[key];
            const av = numeric ? Number(A ?? 0) : String(A ?? '').toLowerCase();
            const bv = numeric ? Number(B ?? 0) : String(B ?? '').toLowerCase();
            return (av === bv ? 0 : (av > bv ? 1 : -1)) * (dir === 'asc' ? 1 : -1);
          });
          renderTable(tableId, rows, columns);
        });
      });
    }

    function uniq(arr){return [...new Set(arr)]}

    function applySearchFilter(rows, q){
      if(!q) return rows;
      q = q.toLowerCase();
      return rows.filter(r => (r.username||'').toLowerCase().includes(q));
    }

    function applySpeciesFilter(rows, species){
      if(!species) return rows;
      return rows.filter(r => (r.species||'') === species);
    }

    function renderSpeciesChips(speciesList){
      const wrap = $('#speciesChips');
      wrap.innerHTML = '';
      speciesList.forEach(s => {
        const el = document.createElement('div');
        el.className = 'species';
        el.innerHTML = `<span class="dot"></span><span>${s}</span>`;
        el.addEventListener('click', () => {
          $('#speciesFilter').value = s; update();
        });
        wrap.appendChild(el);
      });
    }

    async function main(){
      try{
        console.log('[leaderboard] fetching', DATA_URL);
        const data = await loadData();

        const topCatchesRaw = data.top_catches || [];
        const topLevelsRaw  = data.top_levels || [];
        const biggestRaw    = data.biggest_by_species || [];

        const speciesList = uniq(biggestRaw.map(x=>x.species)).sort();
        const sf = $('#speciesFilter');
        speciesList.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sf.appendChild(o); });
        renderSpeciesChips(speciesList);

        const state = { q:'', species:'' };
        function update(){
          state.q = $('#search').value.trim();
          state.species = $('#speciesFilter').value;
          const tc = applySearchFilter(topCatchesRaw, state.q);
          const tl = applySearchFilter(topLevelsRaw, state.q);
          const bg = applySpeciesFilter(biggestRaw, state.species);
          renderTable('top-catches', tc, ['username','total_catches','level']);
          renderTable('top-levels',  tl, ['username','level','xp','total_catches']);
          renderTable('biggest',     bg, ['species','size_mm','username']);
        }

        attachSort('top-catches', topCatchesRaw, ['username','total_catches','level']);
        attachSort('top-levels',  topLevelsRaw,  ['username','level','xp','total_catches']);
        attachSort('biggest',     biggestRaw,    ['species','size_mm','username']);

        $('#search').addEventListener('input', update);
        $('#speciesFilter').addEventListener('change', update);
        update();

        if (data.generated_at){
          const dt = new Date(data.generated_at*1000);
          $('#stamp').textContent = dt.toLocaleString();
        }
      }catch(err){
        showError('Could not load leaderboard data. If running locally, use a web server (file:// fetches will fail).');
        console.error(err);
      }
    }

    main();
  </script>
</body>
</html>
